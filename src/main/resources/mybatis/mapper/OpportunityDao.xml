<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.crm.dao.OpportunityDao" >
    <resultMap id="opportunityMap" type="com.example.crm.entity.Opportunity">
        <id column="opport_id" property="opportId"/>
        <result column="opport_name" property="opportName"/>
        <result column="prob" property="prob"/>
        <result column="forcast_amount" property="forcastAmount"/>
        <result column="is_from_lead" property="isFromLead"/>
        <result column="assign_to" property="assignTo"/>
        <result column="lead_source" property="leadSource"/>
        <result column="update_info" property="updateInfo"/>
        <result column="create_time" property="createTime"/>
        <result column="modified_time" property="modifiedTime"/>
        <result column="opport_type" property="opportType"/>
        <result column="expected_close_date" property="expectedCloseDate"/>
        <result column="description" property="description"/>
        <association property="contact" column="contact_id"
                     javaType="com.example.crm.entity.Contact">
            <id column="contact_id" property="contactId"/>
        </association>
    </resultMap>

    <select id="getOpportunityList" resultMap="opportunityMap">
        select o.*
        from opportunity o
        order by opport_id ASC
    </select>

    <select id="getOpportunity" resultMap="opportunityMap">
        select o.*
        from opportunity o
        where o.opport_id = #{opportId}
    </select>

    <insert id="insertOpportunity" parameterType="com.example.crm.entity.Opportunity" keyProperty="opportId" keyColumn="opport_id">
        insert into opportunity(opport_name,prob,forcast_amount,is_from_lead,assign_to,contact_id,lead_source,update_info,create_time,modified_time,opport_type,expected_close_date,description)
        values(#{opportName},#{prob},#{forcastAmount},#{isFromLead},#{assignTo},#{contact.contactId},#{leadSource},#{updateInfo},#{createTime},#{modifiedTime},#{opportType},#{expectedCloseDate},#{description})
    </insert>

    <update id="updateOpportunity">
        update opportunity
        <set>
            <if test="opportName != null">opport_name = #{opportName},</if>
            <if test="prob != null">prob = #{prob},</if>
            <if test="forcastAmount != null">forcast_amount = #{forcastAmount},</if>
            <if test="isFromLead != null">is_from_lead = #{isFromLead},</if>
            <if test="assignTo != null">assign_to = #{assignTo},</if>
            <if test="leadSource != null">lead_source = #{leadSource},</if>
            <if test="updateInfo != null">update_info = #{updateInfo},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="modifiedTime != null">modified_time = #{modifiedTime},</if>
            <if test="opportType != null">opport_type = #{opportType},</if>
            <if test="expectedCloseDate != null">expected_close_date = #{expectedCloseDate},</if>
            <if test="description != null">description = #{description},</if>
            <if test="contact != null and contact.contactId != null">contact_id = #{contact.contactId}</if>
        </set>
        where opport_id = #{opportId}
    </update>

    <delete id="deleteOpportunity">
        delete from opportunity
        where opport_id = #{opportId}
    </delete>

    <select id="getRecentlyModified" resultMap="opportunityMap">
        select o.*
        from opportunity o
        where modified_time &gt;= (CURRENT_DATE - INTERVAL '30D')
        and modified_time &lt; CURRENT_DATE
    </select>

    <select id="getOpportunity" resultMap="opportunityMap">
        select o.*
        from opportunity o
        <where>
            <if test="opportName!=null">
                opport_name=#{opportName}
            </if>
            <if test="organization != null and organization.organizationName !=null and organization.organizationId != null">
                and organization_id=#{organizationId}
            </if>
            <if test="salesStatus !=null">
                and sales_status=#{salesStatus}
            </if>
            <if test="leadSource !=null">
                and lead_source = #{leadSource}
            </if>
            <if test="expectedCloseDate!=null">
                and expected_close_date=#{expectedCloseDate}
            </if>
            <if test="forcastAmount !=null">
                and forcast_amount = #{forcastAmount}
            </if>
            <if test="assignTo!=null">
                and assign_to=#{assignTo}
            </if>
            <if test="contact != null and contact.contactName !=null and contact.contactId != null">
                and contact_id=#{contactId}
            </if>
        </where>
    </select>
</mapper>